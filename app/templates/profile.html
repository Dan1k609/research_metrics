{% extends "base.html" %}
{% block title %}Личный кабинет{% endblock %}

{% block content %}
<h2>Личный кабинет</h2>

<!-- Базовая информация для любого пользователя -->
<div class="profile-info" style="margin-bottom: 25px;">
    <b>ФИО:</b> {{ user.fio }}<br>
    <b>Email:</b> {{ user.email }}<br>
    <b>Роль:</b> {{ user.role }}
</div>

{# ================== АДМИНИСТРАТОР ================== #}
{% if user.role == 'admin' %}

    <hr>
    <h3>Управление пользователями и ролями</h3>

    <div style="margin-bottom: 15px;">
        <a href="{{ url_for('main.add_user') }}" class="btn">Создать пользователя</a>
    </div>

    {% if users %}
        <table class="table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>ФИО</th>
                    <th>Email</th>
                    <th>Роль</th>
                    <th style="width: 270px;">Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for u in users %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ u.fio }}</td>
                    <td>{{ u.email }}</td>
                    <td>{{ u.role }}</td>
                    <td>
                        <!-- Редактирование -->
                        <a href="{{ url_for('main.edit_user', user_id=u.id) }}" class="btn">Изменить</a>

                        {% if u.role != 'admin' %}
                            <!-- Блокировка / разблокировка -->
                            {% if u.role != 'blocked' %}
                                <form action="{{ url_for('main.block_user', user_id=u.id) }}"
                                      method="post" style="display:inline;">
                                    <button type="submit" class="btn">Заблокировать</button>
                                </form>
                            {% else %}
                                <form action="{{ url_for('main.unblock_user', user_id=u.id) }}"
                                      method="post" style="display:inline;">
                                    <button type="submit" class="btn">Разблокировать</button>
                                </form>
                            {% endif %}

                            <!-- Удаление -->
                            <form action="{{ url_for('main.delete_user_route', user_id=u.id) }}"
                                  method="post" style="display:inline;"
                                  onsubmit="return confirm('Удалить пользователя {{ u.fio }}?');">
                                <button type="submit" class="btn">Удалить</button>
                            </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>Пользователи ещё не созданы.</p>
    {% endif %}

    <hr>
    <h3>Редактирование данных системы</h3>

    <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;">
        <a href="{{ url_for('main.lecturers') }}" class="btn">Преподаватели</a>
        <a href="{{ url_for('main.publications') }}" class="btn">Публикации</a>
        <a href="{{ url_for('main.admin_news') }}" class="btn">Новости</a>
        <a href="{{ url_for('main.admin_faq') }}" class="btn">FAQ</a>
        <a href="{{ url_for('main.log') }}" class="btn">Журнал действий</a>
        <a href="{{ url_for('main.admin_feedback') }}" class="btn">Обращения пользователей</a>
    </div>

{# ================== СОТРУДНИК НАУЧНОГО ОТДЕЛА (staff) ================== #}
{% elif user.role == 'staff' %}

    <hr>
    <h3>Инструменты сотрудника научного отдела</h3>

    <p>Доступны функции проверки публикаций, контроля доработок и экспорта отчётов.</p>

    <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; margin-bottom:15px;">
        <a href="{{ url_for('main.publications') }}" class="btn">Список всех публикаций</a>
        <a href="{{ url_for('main.staff_review') }}" class="btn">Проверка / утверждение</a>
        <a href="{{ url_for('main.staff_export_reports') }}" class="btn">Экспорт отчётов (CSV)</a>
    </div>

    <hr>
    <h3>Публикации на доработке (контроль сроков)</h3>

    {% if revision_pubs and revision_pubs|length > 0 %}
        <table class="table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Название</th>
                    <th>Год</th>
                    <th>Статус</th>
                    <th>Крайний срок доработки</th>
                    <th>Комментарий проверяющего</th>
                </tr>
            </thead>
            <tbody>
                {% for p in revision_pubs %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ p.title }}</td>
                    <td>{{ p.year }}</td>
                    <td>
                        {% if p.status == 'revision_required' %}
                            На доработке
                        {% else %}
                            {{ p.status }}
                        {% endif %}
                    </td>
                    <td>{{ p.revision_deadline or '—' }}</td>
                    <td>{{ p.review_comment or '' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>Сейчас нет публикаций, отправленных на доработку.</p>
    {% endif %}

{# ================== ПРЕПОДАВАТЕЛЬ ================== #}
{% elif user.role == 'lecturer' %}

    <hr>
    <h3>Мои публикации</h3>

    {% if not lecturer_info %}
        <p style="color:red;">
            Для вашей учётной записи не найден связанный преподаватель в справочнике.<br>
            Связь выполняется через поле <code>lecturer_id</code> в таблице пользователей.
        </p>
    {% else %}
        <p>
            <b>Преподаватель:</b> {{ lecturer_info.fio }}<br>
            <b>Кафедра:</b> {{ lecturer_info.department }}<br>
            <b>Должность:</b> {{ lecturer_info.position }}
        </p>

        {% if lecturer_pubs and lecturer_pubs|length > 0 %}
            <table class="table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Название</th>
                        <th>Год</th>
                        <th>Журнал</th>
                        <th>Статус</th>
                        <th>Крайний срок доработки</th>
                        <th>Комментарий сотрудника НО</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in lecturer_pubs %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ p.title }}</td>
                        <td>{{ p.year }}</td>
                        <td>{{ p.journal }}</td>
                        <td>
                            {% if not p.status or p.status == 'new' %}
                                Новая
                            {% elif p.status == 'approved' %}
                                Утверждена
                            {% elif p.status == 'rejected' %}
                                Отклонена
                            {% elif p.status == 'revision_required' %}
                                На доработке
                            {% else %}
                                {{ p.status }}
                            {% endif %}
                        </td>
                        <td>{{ p.revision_deadline or '—' }}</td>
                        <td>{{ p.review_comment or '' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>За вами пока не закреплено ни одной публикации.</p>
        {% endif %}
    {% endif %}

{# ================== ПРОЧИЕ РОЛИ / ПО УМОЛЧАНИЮ ================== #}
{% else %}

    <hr>
    <p>Добро пожаловать в личный кабинет!</p>
    <p>Ваша роль: <b>{{ user.role }}</b></p>

{% endif %}

{% endblock %}
